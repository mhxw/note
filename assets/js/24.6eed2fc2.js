(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{436:function(t,s,a){"use strict";a.r(s);var n=a(11),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"一-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-前言"}},[t._v("#")]),t._v(" 一. 前言")]),t._v(" "),a("p",[t._v("接上一篇"),a("RouterLink",{attrs:{to:"/_posts/2021-4-25-install-prometheus-on-linux.html"}},[t._v("Prometheus+Grafana监控部署")]),t._v("，环境已经安装完成，本篇进行学习使用Alertmanager告警配置。")],1),t._v(" "),a("h2",{attrs:{id:"二、介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、介绍"}},[t._v("#")]),t._v(" 二、介绍")]),t._v(" "),a("p",[t._v("AlertManager是一个独立的告警模块，接收Prometheus等客户端发来的警报，之后通过分组、删除重复等处理，并将它们通过路由发送给正确的接收器。")]),t._v(" "),a("h2",{attrs:{id:"三、安装部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、安装部署"}},[t._v("#")]),t._v(" 三、安装部署")]),t._v(" "),a("h3",{attrs:{id:"_1、下载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、下载"}},[t._v("#")]),t._v(" 1、下载")]),t._v(" "),a("p",[t._v("https://prometheus.io/download/")]),t._v(" "),a("h3",{attrs:{id:"_2、解压"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、解压"}},[t._v("#")]),t._v(" 2、解压")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /mhxw/prometheus/alertmanager\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/prometheus/alertmanager/releases/download/v0.22.2/alertmanager-0.22.2.linux-amd64.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf alertmanager-0.22.2.linux-amd64.tar.gz -C /mhxw/prometheus/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /mhxw/prometheus/alertmanager-0.22.2.linux-amd64/* /mhxw/prometheus/alertmanager\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /mhxw/prometheus/alertmanager\n")])])]),a("ul",[a("li",[t._v("查看版本")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("/mhxw/prometheus/alertmanager/alertmanager --version\n")])])]),a("h3",{attrs:{id:"_3、编辑alertmanager配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、编辑alertmanager配置文件"}},[t._v("#")]),t._v(" 3、编辑"),a("code",[t._v("alertmanager")]),t._v("配置文件")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /mhxw/prometheus/alertmanager/alertmanager.yml\n")])])]),a("p",[t._v("配置文件说明")]),t._v(" "),a("ul",[a("li",[t._v("全局配置（global）：用于定义一些全局的公共参数，如全局的SMTP配置，Slack配置等内容；")]),t._v(" "),a("li",[t._v("模板（templates）：用于定义告警通知时的模板，如HTML模板，邮件模板等；")]),t._v(" "),a("li",[t._v("告警路由（route）：根据标签匹配，确定当前告警应该如何处理；")]),t._v(" "),a("li",[t._v("接收人（receivers）：接收人是一个抽象的概念，它可以是一个邮箱也可以是微信，Slack或者Webhook等，接收人一般配合告警路由使用；")]),t._v(" "),a("li",[t._v("抑制规则（inhibit_rules）：合理设置抑制规则可以减少垃圾告警的产生")])]),t._v(" "),a("p",[t._v("完整配置格式如下：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("global:\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" resolve_timeout: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("duration"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 5m "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_from: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("tmpl_string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_smarthost: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_hello: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_auth_username: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_auth_password: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_auth_identity: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_auth_secret: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" smtp_require_tls: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("bool"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" slack_api_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" victorops_api_key: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" victorops_api_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://alert.victorops.com/integrations/generic/20131114/alert/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" pagerduty_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://events.pagerduty.com/v2/enqueue"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" opsgenie_api_key: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" opsgenie_api_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://api.opsgenie.com/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" hipchat_api_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://api.hipchat.com/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" hipchat_auth_token: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" wechat_api_url: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://qyapi.weixin.qq.com/cgi-bin/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" wechat_api_secret: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" wechat_api_corp_id: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" http_config: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("http_config"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\ntemplates:\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("filepath"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nroute: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("route"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\nreceivers:\n  - "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("receiver"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n\ninhibit_rules:\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("inhibit_rule"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("文件内容如下：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("global:\n  resolve_timeout: 5m\n  smtp_smarthost: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"smtp.qq.com:587"')]),t._v("\n  smtp_from: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"****@foxmail.com"')]),t._v("\n  smtp_auth_username: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"****@foxmail.com"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#邮箱专用授权码")]),t._v("\n  smtp_auth_password: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"****"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#关闭TLS授权")]),t._v("\n  smtp_require_tls: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\nroute:\n  group_by: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mhxw_status'")]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_status'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#与prometheus配置文件alert_rules.yml中配置规则名对应")]),t._v("\n  group_wait: 30s "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#报警等待时间")]),t._v("\n  group_interval: 5m "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#报警间隔时间")]),t._v("\n  repeat_interval: 1h "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#重复报警间隔时间")]),t._v("\n  receiver: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mhxw_receiver'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#告警处理方式")]),t._v("\nreceivers:\n- name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mhxw_receiver'")]),t._v("\n  email_configs:\n    - to: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mhxw@gmail.com'")]),t._v("\n      send_resolved: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\ninhibit_rules:\n  - source_match:\n      severity: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'critical'")]),t._v("\n    target_match:\n      severity: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'warning'")]),t._v("\n    equal: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alertname'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dev'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'instance'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("ul",[a("li",[t._v("template目录下"),a("code",[t._v("node_status.tmpl")])])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" define "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node.status.message"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" gt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len .Alerts.Firing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- range "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$index")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(" :"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" .Alerts -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" eq "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n**********MHXW告警通知**********\nMHXW告警类型: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.alertname "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n告警级别: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.level "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\nMHXW告警主题: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Annotations.summary "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMHXW告警详情: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Annotations.description "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMHXW故障时间: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".StartsAt.Add 28800e9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Format "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2006-01-02 15:04:05"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" gt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("故障实例: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.instance "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" gt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len .Alerts.Resolved"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- range "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$index")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(" :"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" .Alerts -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" eq "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n**********恢复通知**********\n告警类型: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.alertname "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n告警级别: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.level "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n告警主题: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Annotations.summary "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n告警详情: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Annotations.description "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n故障时间: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".StartsAt.Add 28800e9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Format "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2006-01-02 15:04:05"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n恢复时间: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".EndsAt.Add 28800e9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Format "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2006-01-02 15:04:05"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" gt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("故障实例: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$alert")]),t._v(".Labels.instance "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("- end "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("配置说明")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("global: 全局配置，包括报警解决后的超时时间、SMTP 相关配置、各种渠道通知的 API 地址等等。")])]),t._v(" "),a("li",[a("p",[t._v("route: 用来设置报警的分发策略，它是一个树状结构，按照深度优先从左向右的顺序进行匹配。")])]),t._v(" "),a("li",[a("p",[t._v("receivers: 配置告警消息接受者信息，例如常用的 email、wechat、slack、webhook 等消息通知方式。")])]),t._v(" "),a("li",[a("p",[t._v("inhibit_rules: 抑制规则配置，当存在与另一组匹配的警报（源）时，抑制规则将禁用与一组匹配的警报（目标）。")])]),t._v(" "),a("li",[a("p",[t._v("smtp_smarthost: 这里为 QQ 邮箱 SMTP 服务地址，官方地址 smtp.qq.com 端口为 465 或 587，同时设置开启 POP3/SMTP 服务。")])]),t._v(" "),a("li",[a("p",[t._v("smtp_auth_password: 这里为第三方登录 QQ 邮箱的授权码，非 QQ 账户登录密码，否则会报错，获取方式在 QQ 邮箱服务端设置开启 POP3/SMTP 服务时会提示。")])])]),t._v(" "),a("h3",{attrs:{id:"_4、检查alertmanager配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、检查alertmanager配置文件"}},[t._v("#")]),t._v(" 4、检查AlertManager配置文件")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("/usr/local/Prometheus/alertmanager/amtool check-config /usr/local/Prometheus/alertmanager/alertmanager.yml\n")])])]),a("h3",{attrs:{id:"_5、启动alertmanager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5、启动alertmanager"}},[t._v("#")]),t._v(" 5、启动AlertManager")]),t._v(" "),a("p",[t._v("一种是采用"),a("code",[t._v("tmux")]),t._v("方式")]),t._v(" "),a("ul",[a("li",[t._v("新建会话")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("tmux new -s alertmanager\n")])])]),a("ul",[a("li",[t._v("进入会话")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("tmux a -t alertmanager\n/mhxw/prometheus/alertmanager/alertmanager --config.file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/mhxw/prometheus/alertmanager/alertmanager.yml --web.listen-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(":1998\n")])])]),a("p",[t._v("一种是"),a("code",[t._v("systemd")]),t._v("采用开机启动方式")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/systemd/system/alertmanager.service "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"EOF"\n[Unit]\nDescription=alertmanager\nAfter=local-fs.target network-online.target network.target\nWants=local-fs.target network-online.target network.target\n \n[Service]\nExecStart=/mhxw/prometheus/alertmanager/alertmanager --config.file=/mhxw/prometheus/alertmanager/alertmanager.yml --web.listen-address=:1998\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF')]),t._v("\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("systemctl daemon-reload\n\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" alertmanager\n\nsystemctl start alertmanager\n\nsystemctl status alertmanager\n")])])]),a("h2",{attrs:{id:"四、重新配置prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、重新配置prometheus"}},[t._v("#")]),t._v(" 四、重新配置Prometheus")]),t._v(" "),a("h3",{attrs:{id:"_1、编辑prometheus-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、编辑prometheus-yml"}},[t._v("#")]),t._v(" 1、编辑prometheus.yml")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /mhxw/prometheus/prometheus/prometheus.yml\n")])])]),a("ul",[a("li",[t._v("告警配置连接")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Alertmanager configuration")]),t._v("\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n       - alertmanager:1998\n")])])]),a("ul",[a("li",[t._v("开启告警配置")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("rule_files:\n   - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rules/*.yml"')]),t._v("\n")])])]),a("ul",[a("li",[t._v("监控AlertManager")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("- job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alertmanager'")]),t._v("\n    static_configs:\n      - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:1998'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("ul",[a("li",[t._v("文件内容")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# my global config")]),t._v("\nglobal:\n  scrape_interval:     15s "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Set the scrape interval to every 15 seconds. Default is every 1 minute.")]),t._v("\n  evaluation_interval: 15s "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Evaluate rules every 15 seconds. The default is every 1 minute.")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# scrape_timeout is set to the global default (10s).")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Alertmanager configuration")]),t._v("\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost:1998"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.")]),t._v("\nrule_files:\n   - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rules/*.yml"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# - "second_rules.yml"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# A scrape configuration containing exactly one endpoint to scrape:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Here it's Prometheus itself.")]),t._v("\nscrape_configs:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.")]),t._v("\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'prometheus'")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# metrics_path defaults to '/metrics'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# scheme defaults to 'http'.")]),t._v("\n\n    static_configs:\n    - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:9090'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#追加以下内容")]),t._v("\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_exporter-1'")]),t._v("\n    static_configs:\n    - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:9101'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#安装node_exporter的服务器")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#追加以下内容")]),t._v("\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mhxw'")]),t._v("\n    static_configs:\n    - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'47.242.76.64:26635'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#安装mhxw的服务器")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#追加以下内容")]),t._v("\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'alertmanager'")]),t._v("\n    static_configs:\n    - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:1998'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#alertmanager")]),t._v("\n\n\n\n")])])]),a("ul",[a("li",[t._v("检查并重新加载配置文件")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("/usr/local/Prometheus/promtool check config /usr/local/Prometheus/prometheus.yml\n")])])]),a("h3",{attrs:{id:"_2、创建告警目录-添加报警规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、创建告警目录-添加报警规则"}},[t._v("#")]),t._v(" 2、创建告警目录&添加报警规则")]),t._v(" "),a("p",[t._v("在prometheus.yml的同级目录下，创建rules目录，在该rules目录下创建node_alerts.yml文件，内容如下：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" rules "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" rules/\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" node_alerts.yml\n")])])]),a("p",[t._v("文件内容")]),t._v(" "),a("blockquote",[a("p",[t._v("注意")]),t._v(" "),a("p",[t._v("为了方便测试，我这里把调整磁盘使用率阀值测试报警调整到1，然后重新加载配置。")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("groups:\n  - name: node_status\n    rules:\n    - alert: DiskUsageAlert_warning\n      expr: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" - node_filesystem_free_bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("fstype"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rootfs"')]),t._v(",mountpoint"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",mountpoint"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("~"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/(run|var|sys|dev).*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" / node_filesystem_size_bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" * "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      for: 2m\n      labels:\n        level: warning\n      annotations:\n        summary: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"主机 {{ '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$labels")]),t._v('.instance }} 磁盘使用率高"')]),t._v("\n        description: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$labels")]),t._v(".instance}}: 磁盘使用率超过80％ (当前占比为: {{ "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$value")]),t._v(' }})"')]),t._v("\n")])])]),a("h3",{attrs:{id:"_3、重启prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、重启prometheus"}},[t._v("#")]),t._v(" 3、重启Prometheus")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("systemctl restart prometheus\n")])])]),a("p",[t._v("警报有三种状态：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Inactive 警报未激活；")])]),t._v(" "),a("li",[a("p",[t._v("Pending：警报已满足测试表达式条件，但未达到for指定的持续时间；")])]),t._v(" "),a("li",[a("p",[t._v("Firing：警报满足测试表达式条件，且持续时间达到了for指定的持续时间；")])])]),t._v(" "),a("h3",{attrs:{id:"_4、查看邮件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、查看邮件"}},[t._v("#")]),t._v(" 4、查看邮件")]),t._v(" "),a("h2",{attrs:{id:"参考文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[t._v("#")]),t._v(" 参考文档")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("https://zhuanlan.zhihu.com/p/74932366\nhttp://www.linuxe.cn/post-514.html\nhttps://www.cnblogs.com/longcnblogs/p/9620733.html\nhttps://www.cnblogs.com/jiujuan/p/13262380.html\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);